这份文档是为你后续编写《详细设计文档》做准备的**高层级产品需求文档 (PRD)**。它剥离了具体的代码实现细节，专注于**业务逻辑、用户场景、功能定义**以及**潜在风险的深度评估**。

---

# 产品需求文档 (PRD): X-Puzzle-Kit (推特拼图还原助手)

| 文档属性     | 内容                                                                                                |
| ------------ | --------------------------------------------------------------------------------------------------- |
| **项目名称** | X-Puzzle-Kit                                                                                        |
| **版本号**   | v1.0                                                                                                |
| **文档状态** | 正式版                                                                                              |
| **核心目标** | 解决 Twitter (X) 平台多图分割展示导致的用户浏览割裂感，提供一键还原、无缝拼接、高清归档的解决方案。 |

---

## 1. 需求背景与市场分析

### 1.1 背景痛点

Twitter (X) 的图片展示机制（尤其是 2x2 网格）催生了多种独特的创作文化：

1. **悬念式拼图：** 利用缩略图的裁剪制造悬念，诱导用户点击查看原图（如示例中的“嘴里吐出…”）。
2. **无缝大图：** 画师将一张完整的宽幅或高幅插画切割成 2~4 张上传，在 Timeline 上形成视觉冲击力，但保存时变成碎片。
3. **四格漫画 (4-koma)：** 虽然是 4 张图，但实际阅读顺序是垂直的，而 Twitter 强制显示为田字格，导致阅读顺序错乱。

**痛点：** 用户想要保存这些作品时，需要手动下载多张图片，再使用第三方软件拼接，步骤繁琐且容易在下载过程中损失画质。

### 1.2 竞品/现状分析

- 目前市面上的推特下载器大多只提供“打包下载（ZIP）”功能，极少提供“即时拼接”功能。
- 部分在线工具需要复制链接跳转，中断了浏览体验。
- **机会点：** 一个嵌入式的、本地处理的、支持自定义布局的轻量级工具。

---

## 2. 拼图类型与场景分析 (Use Case Research)

在设计拼接算法前，我们必须穷举 Twitter 上常见的“多图组合”形态，这是需求的核心输入。

| 类型                        | 图片数量  | 描述                                                                                      | 拼接需求 (默认)                         |
| --------------------------- | --------- | ----------------------------------------------------------------------------------------- | --------------------------------------- |
| **田字格 (Standard Grid)**  | 4         | 最常见的拼图。原图通常为正方形或 4:3 比例。                                               | **2x2 矩阵** (左上→右上→左下→右下)      |
| **四格漫 (Vertical Strip)** | 4         | 叙事性漫画，被切分为 4 张。                                                               | **1x4 垂直** (上→下)                    |
| **横长卷 (Panorama)**       | 2 / 3 / 4 | 宽幅风景或全员集合图。                                                                    | **Nx1 水平** (左→右)                    |
| **竖长条 (Long Vertical)**  | 2         | 极高的立绘或长条漫，因推特限制被切成两半。                                                | **1x2 垂直** (上→下)                    |
| **T型布局 (The T-Shape)**   | 3         | Twitter 对 3 张图的默认展示是：左边一张大竖图，右边两张小横图。画师有时会配合此布局创作。 | **特殊布局** (需还原 UI 布局或转为横排) |
| **乱序/欺诈图**             | N         | 画师为了防爬虫或制造恶搞效果，故意打乱上传顺序。                                          | **需人工干预** (拖拽排序)               |

---

## 3. 功能需求说明 (Functional Requirements)

### 3.1 核心业务流程

1. **识别与解析：** 自动检测当前浏览的推文是否包含多张图片。
2. **触发操作：** 用户通过显性交互（按钮/菜单）触发拼接请求。
3. **资源获取：** 系统提取最高质量的原图数据（非缩略图）。
4. **智能预处理：** 根据图片数量和尺寸，推荐最佳拼接布局。
5. **用户干预（关键）：** 提供可视化界面供用户调整顺序和模式。
6. **合成与输出：** 生成单张图片文件并触发下载。

### 3.2 详细功能点

#### F1. 图像源获取 (Source Acquisition)

- **R1.1 高清强制：** 系统**必须**获取图片服务器上的原图链接（通常带有 `name=orig` 参数），严禁使用 Timeline 上的压缩预览图进行拼接，以防止画质模糊。
- **R1.2 格式兼容：** 必须支持 JPEG, PNG, WEBP 等 Twitter 常见图片格式。

#### F2. 智能拼接引擎 (Stitching Engine)

- **R2.1 自动布局推荐：**
- 若图片数量=4，默认推荐“田字格 (2x2)”。
- 若图片数量=2，根据图片长宽比判断：若两图均为竖长图，推荐“横拼”；若为横长图，推荐“竖拼”。

- **R2.2 尺寸归一化 (Normalization)：**
- 当拼接的两张图片尺寸不一致时（例如图1高度1000px，图2高度1005px），系统应具备“基准对齐”逻辑（如以第一张图为基准，等比缩放第二张图），防止拼接处出现错位或黑边。

#### F3. 交互编辑器 (Interactive Editor)

_这是用户体验的核心差异化功能。_

- **R3.1 模态预览窗口：** 触发后不应直接下载，应弹出一个浮层显示预览结果。
- **R3.2 布局切换器：** 用户可一键切换拼接模式：
- [2x2] [1x4 竖] [4x1 横]
- [1x2 竖] [2x1 横]

#### F4. 输出与归档 (Output)

- **R4.1 自动命名：** 文件名应包含元数据，格式示例：`{Artist_Handle}_{Tweet_ID}_stitched.png`。
- **R4.2 格式选择：** 允许用户选择导出为 PNG (无损) 或 JPG (体积小)。

#### F5. 移动端特定需求 (Mobile Specific)

- **R5.1 离线/本地处理：** 移动端应尽量在本地完成拼接，避免上传图片到服务器（节省用户流量，保护隐私）。

### 3.3 额外特性 (Extra Features)

#### F6. 图片分割器 (Image Splitter)

_这是开发过程中新增的反向功能，用于将一张大图分割为推特友好的多图格式。_

- **R6.1 分割模式**：
  - **网格分割 (Grid)**：将图片分割为 2x2, 3x3 等网格。
  - **行/列分割**：将长图垂直或水平切割为 N 等份。
  - **T型分割**：将图片分割为左1右2的特殊布局。
- **R6.2 推特优化 (Twitter Optimized)**：
  - 提供 "Twitter Optimize" 开关，自动将分割后的图片裁剪为推特预览的最佳比例 (如 16:9)。
- **R6.3 压缩包导出**：
  - 支持将分割后的多张图片打包为 ZIP 下载。

#### F7. 系统集成与个性化

- **R7.1 右键菜单 (Context Menu)**：
  - 集成浏览器右键菜单 "Split Image"，支持在网页上直接对图片发起分割任务。
- **R7.2 主题适配**：
  - 支持 浅色 (Light)、深色 (Dark) 及 跟随系统 (Auto) 三种主题模式。
- **R7.3 多语言支持 (i18n)**：
  - 内置 简体/繁体中文、英语、日语、韩语、西班牙语、法语支持，自动匹配浏览器语言。

---

## 4. 非功能需求 (Non-Functional Requirements)

### 4.1 性能要求

- **响应速度：** 点击拼接按钮后，预览图生成时间应在 2 秒内（视网络下载原图速度而定）。
- **内存管理：** 在处理 4 张 4K 原图拼接时，不得导致浏览器崩溃或手机 App 闪退（需考虑 Canvas 内存限制）。

### 4.2 兼容性与稳定性

- **DOM 鲁棒性：** PC端插件应尽量减少对 CSS Class 的依赖，优先使用 `data-testid` 或相对结构定位，以抵抗 Twitter 前端频繁改版。
- **跨域 (CORS) 合规：** 必须妥善处理 Canvas 跨域污染问题，确保导出的图片有效。

### 4.3 隐私与安全

- **零数据上传：** 所有的图片拼接处理**必须**在客户端（浏览器/手机本地）完成。严禁将用户图片上传至开发者服务器。

---

## 5. 风险评估与应对策略 (Risk Assessment)

在编写详细设计文档时，必须重点解决以下高风险问题：

| 风险类别     | 风险描述                      | 严重度 | 应对策略建议 |
| ------------ | ----------------------------- | ------ | ------------ |
| **技术风险** | **Twitter 前端架构重构** <br> |

<br> 推特经常更改 DOM 结构，导致插件找不到图片或按钮。 | **高** | 1. 建立自动化监控机制（每日检测）。<br>

<br> 2. 选择器设计需具备回退机制（若 A 策略失败，尝试 B 策略）。<br>

<br> 3. 支持云端下发“选择器规则配置文件”，无需更新 App/插件即可修复。 |
| **技术风险** | **混合尺寸拼接缝隙** <br>

<br> 画师上传的切片可能存在 1~2 像素的误差，导致拼接后出现明显接缝。 | 中 | 1. 引入“边缘融合”或“容差裁剪”算法。<br>

<br> 2. 默认以第一张图为尺寸基准进行强制缩放对齐。 |
| **合规风险** | **版权与盗图争议** <br>

<br> 拼接工具可能被用于去除水印或盗用付费内容。 | 低 | 1. 在保存的文件元数据 (EXIF) 中自动写入原推文链接。<br>

<br> 2. 仅作为工具提供，不提供内容托管服务。 |
| **体验风险** | **移动端内存溢出 (OOM)** <br>

<br> 某些 Android 机型在处理 4 张超大图生成的 Bitmap 时可能崩溃。 | 中 | 1. 检测系统可用内存。<br>

<br> 2. 提供“高清/标清”输出选项。若内存不足，自动降级处理。 |
| **平台风险** | **iOS 快捷指令限制** <br>

<br> iOS 快捷指令分配的运行内存有限，且 Safari 脚本执行时间受限。 | 中 | 若纯端侧处理失败，可考虑降级为“服务端辅助解析 URL，端侧下载拼接”的混合模式。 |

---

## 6. 项目分期规划 (Phasing)

为了降低开发风险，建议分阶段实施：

- **P0 (MVP - 最小可行性产品):**
- 平台：仅 PC 浏览器（油猴脚本/插件）。
- 功能：支持 4 张图默认 2x2 拼接，无编辑界面，直接下载。
- 目的：验证 DOM 解析稳定性和 Canvas 跨域方案。

- **P1 (标准版):**
- 平台：PC 插件 + Android 简易工具。
- 功能：加入“预览编辑器”，支持拖拽排序、2/3图布局适配。

- **P2 (完整版):**
- 平台：全平台覆盖（含 iOS）。
- 功能：支持自定义文件名模版、历史记录、批量处理、单图旋转/翻转等高级功能。

---

### 下一步建议

基于此文档，你在撰写**详细设计文档 (Detailed Design Document)** 时，应着重设计以下模块：

1. **数据结构设计：** 如何定义一个“待拼接任务”的对象结构（包含 URL 数组、原始顺序、用户调整后的顺序、目标布局类型）。
2. **算法流程图：** 针对 F2.2 尺寸归一化，画出具体的计算逻辑流程图。
3. **组件通信时序图：** 描述 PC 插件 Content Script 如何与 Background Script 以及 UI 弹窗进行通信。
